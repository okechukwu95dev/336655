name: Fetch Games

on:
  workflow_dispatch:
    inputs:
      start_date:
        description: 'Start date (MM/DD/YYYY)'
        required: true
        default: '12/12/2025'
      end_date:
        description: 'End date (MM/DD/YYYY)'
        required: true
        default: '22/12/2025'

permissions:
  contents: write

jobs:
  fetch_shard:
    name: Fetch Shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        shard: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14]

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'
          
      - name: Install Dependencies
        run: pip install -r requirements.txt
        
      - name: Run Shard ${{ matrix.shard }}
        run: |
          python fetch_manager.py "${{ inputs.start_date }}" "${{ inputs.end_date }}" --shard ${{ matrix.shard }} --shards 15
          
      - name: Upload Shard Artifact
        uses: actions/upload-artifact@v4
        with:
          name: games_shard_${{ matrix.shard }}
          path: games_shard_*.db
          retention-days: 1

  merge_and_push:
    name: Merge & Push
    needs: fetch_shard
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Dependencies
        run: pip install -r requirements.txt
        
      - name: Download All Shards
        uses: actions/download-artifact@v4
        with:
          pattern: games_shard_*
          merge-multiple: true
          
      - name: List Artifacts
        run: ls -lh games_shard_*.db
        
      - name: Restore Base DB (Optional)
        run: |
          if [ -f games.db.b64 ]; then
            base64 -d games.db.b64 > games.db
          fi
          
      - name: Merge Shards
        run: python fetch_manager.py --merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REPOSITORY: ${{ github.repository }}
